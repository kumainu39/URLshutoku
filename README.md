# URL取得支援ツール

法人番号データベースに登録された会社の名称・住所を基に公式サイトと企業情報を収集するためのツールです。FastAPI ベースの Web UI からジョブを作成し、検索〜確認〜データ更新までを自動化します。

## 主な機能

- DuckDuckGo を利用した企業ホームページ候補の検索
- 正規化とファジーマッチングによる会社名・住所の照合
- 住所が一致したページから資本金・業種などを抽出
- 既に URL が登録済みのレコードのスキップ
- 都道府県や処理件数でのフィルタリング
- 並列処理による検索・取得の高速化
- 任意で LLaMA (llama-cpp-python) を利用した確認精度向上
- UI 上でのジョブ管理とログ閲覧

## セットアップ

1. 依存パッケージをインストールします。

   ```bash
   pip install -e .
   # LLM を利用する場合
   pip install -e .[llm]
   ```

2. `.env` ファイルで設定を上書きできます (任意)。

   ```env
   DATABASE_URL=sqlite:///./companies.db
   SEARCH_RESULT_LIMIT=5
   LLM_ENABLED=false
   LLM_MODEL_PATH=/path/to/llama-3-elyza-jp-8b-gguf
   ```

   `LLM_ENABLED=true` と `LLM_MODEL_PATH` を指定すると `llama-cpp-python` を通じてローカルモデルを利用します。

3. 既存の法人番号データベースを SQLite / PostgreSQL などの SQLAlchemy 対応 DB として用意し、`companies` テーブルの構造を `app/db.py` に合わせてください。

4. アプリケーションを起動します。

   ```bash
   uvicorn app.main:app --reload
   ```

5. ブラウザで `http://localhost:8000` にアクセスし、UI からジョブを作成します。

## ジョブ設定

- **都道府県フィルタ**: 住所に含まれる都道府県名でフィルタリング。
- **最大処理件数**: 実行ジョブで処理する件数の上限。
- **1回の取得件数**: DB から読み込むバッチサイズ (デフォルト 100 件)。
- **並列数**: HTTP アクセスなどの並列度を設定 (内部のセマフォに反映)。
- **既存URLスキップ**: 既に URL が登録されているレコードを除外。

ジョブ実行中はログが UI に表示され、進捗・成功件数・失敗件数などが確認できます。

## 注意点

- 大量アクセスになる可能性があるため、検索エンジンや各サイトの利用規約・robots.txt を遵守してください。
- LLM 連携はオプションです。モデルを読み込むには十分なメモリと CPU/GPU 資源が必要です。
- 5 百万件を超えるレコードを扱う場合、DB のインデックスやワーカーの並列度を環境に合わせて調整してください。
- DuckDuckGo から取得した URL が企業トップページでない場合があります。その場合もサイト内の会社情報ページをクロールして一致するページを探します。

## ライセンス

このリポジトリのコードは MIT ライセンスで提供されています。
